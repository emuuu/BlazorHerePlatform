@using System
@using System.Threading.Tasks
@using Microsoft.AspNetCore.Components
@using Microsoft.JSInterop

@inherits MapComponent
@inject IJSRuntime JSRuntime

<div @ref="@Element" id="@Id" class="@CssClass" style="@StyleStr" @attributes="UserAttributes"></div>

@code {
    [Parameter]
    public string? Id { get; set; }

    [Parameter]
    public MapOptions? Options { get; set; }

    [Parameter]
    public EventCallback OnAfterInit { get; set; }

    [Parameter]
    public string? CssClass { get; set; }

    /// <summary>
    /// Default height 500px.
    /// Used as style attribute "height: {Height}"
    /// </summary>
    [Parameter]
    public string Height { get; set; } = "500px";

    private string StyleStr => $"height: {Height};";

    private ElementReference Element { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitAsync(Element, Options);
            await OnAfterInit.InvokeAsync();
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    /// <summary>
    /// Disposes the current map and re-creates it with the current Options.
    /// Use this after changing Options that require a full map rebuild (e.g. UiLocale).
    /// </summary>
    public async Task ReInitializeAsync(MapOptions? options = null)
    {
        await DisposeMapAsync();
        await InitAsync(Element, options ?? Options);
        await OnAfterInit.InvokeAsync();
    }

    /// <summary>
    /// Returns false because the map's visual state is managed entirely by the
    /// HERE Maps JS API. Blazor re-renders would disrupt the map container.
    /// Use ReInitializeAsync() to rebuild the map after option changes.
    /// </summary>
    protected override bool ShouldRender() => false;
}
